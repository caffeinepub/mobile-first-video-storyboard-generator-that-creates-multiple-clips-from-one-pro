{
  "kind": "build_request",
  "title": "Fix prompt-based video generation failures (including reference image runs) and correct Clips progress/UI states",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-47",
      "text": "Fix the Grok clip-generation request so generating a video from a prompt works reliably (including when the user uploads reference images such as IMG_0793.png), and ensure failures are surfaced as clear in-app errors (English) instead of silently producing empty/invalid clip URLs.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "recent-messages-user-1"
        ],
        "quotes": [
          "Fix when trying to generate a video with a prompt"
        ]
      },
      "acceptanceCriteria": [
        "Generating with Grok configured succeeds for at least one clip when using a text prompt with 1 uploaded reference image (e.g., IMG_0793.png), producing a non-empty, playable video URL.",
        "If the Grok API request fails (non-2xx) or returns an unexpected response shape, the clip is marked Failed and the user sees a concise English error message in the clip card (not a blank clip).",
        "The app does not append placeholder ClipData with url: '' on failure; failed clips do not create a preview attempt using an empty URL.",
        "When a request includes reference images and fails, the surfaced error message explicitly indicates that reference images were included and suggests trying again without them (while keeping the underlying technical details available for debugging/logs where applicable)."
      ]
    },
    {
      "id": "REQ-48",
      "text": "Correct the Clips-step overall progress calculation and labeling so the UI never reports 100% complete while 0 clips are completed (e.g., when all clips failed). Progress and label must accurately reflect completed vs failed clips during and after generation.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "recent-messages-user-1"
        ],
        "quotes": [
          "Fix when trying to generate a video with a prompt"
        ]
      },
      "acceptanceCriteria": [
        "If all segments are failed and completedCount is 0, the overall progress displayed is not 100%, and the label indicates generation failed (English).",
        "If some clips completed and some failed, the label clearly shows both counts (e.g., \"1 completed, 1 failed\") and progress represents completed clips only (not \"done\" clips).",
        "While a clip is generating, overall progress continues to update smoothly and never reaches 100% until at least one clip is actually completed (as applicable for the run)."
      ]
    },
    {
      "id": "REQ-49",
      "text": "Eliminate any remaining user-visible native video 'Load failed' experience in the Clips step by ensuring the app renders only stable in-app preview states (playable video, or an in-app error with a Retry action) and never relies on the browser’s native <video> error UI for clip previews.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "recent-messages-user-1"
        ],
        "quotes": [
          "Fix when trying to generate a video with a prompt"
        ]
      },
      "acceptanceCriteria": [
        "When a generated clip URL cannot be loaded/played, the clip preview area shows the app’s custom error UI (English) with a Retry button, and the browser’s native 'load failed' overlay is not shown.",
        "Retrying from the preview error state triggers the existing retry flow for that clip and updates status/progress accordingly.",
        "The clip preview component does not render a <video> element at all for empty/whitespace URLs."
      ]
    }
  ],
  "constraints": [
    "Frontend immutable paths must not be modified: frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useInternetIdentity.tsx, frontend/src/hooks/useActor.ts, frontend/src/main.tsx, frontend/src/components/ui.",
    "Backend must remain a single Motoko actor (no additional backend services).",
    "Use English for all user-facing text."
  ],
  "nonGoals": [
    "Adding new providers or reintroducing Demo mode.",
    "Changing the overall multi-step flow (Prompt → Clips → Compose → Download) beyond the fixes described.",
    "Backend schema/state migrations unless strictly required for these frontend fixes."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}